name: Automated Branch Synchronization

on:
  schedule:
    - cron: '35 6 * * *'   # Runs daily at 10:00 UTC
  workflow_dispatch:        # Manual trigger

env:
  SOURCE_BRANCH: b1
  DESTINATION_BRANCHES: b2,b3
  LINES_CHANGED_THRESHOLD: 0

jobs:
  auto-sync:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for diff

      - name: Set up Git config
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"

      - name: Authenticate GitHub CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Compare and Sync Branches
        run: |
          IFS=',' read -ra DESTS <<< "$DESTINATION_BRANCHES"

          for TARGET_BRANCH in "${DESTS[@]}"; do
            echo "🔍 Checking diff: $SOURCE_BRANCH → $TARGET_BRANCH"
            git fetch origin $SOURCE_BRANCH $TARGET_BRANCH

            DIFF_STATS=$(git diff origin/$TARGET_BRANCH..origin/$SOURCE_BRANCH --shortstat)
            echo "Diff stats: $DIFF_STATS"

            ADDED=$(echo "$DIFF_STATS" | grep -oP '\d+(?= insertions)' || echo "0")
            DELETED=$(echo "$DIFF_STATS" | grep -oP '\d+(?= deletions)' || echo "0")
            TOTAL_CHANGED=$((ADDED + DELETED))

            echo "📈 Total lines changed: $TOTAL_CHANGED"

            if [ "$TOTAL_CHANGED" -gt "$LINES_CHANGED_THRESHOLD" ]; then
              echo "✅ Change threshold met: proceeding with PR."

              PR_EXISTS=$(gh pr list --base "$TARGET_BRANCH" --head "$SOURCE_BRANCH" --json number --jq 'length')
              if [[ "$PR_EXISTS" -eq "0" ]]; then
                gh pr create \
                  --base "$TARGET_BRANCH" \
                  --head "$SOURCE_BRANCH" \
                  --title "🔄 Auto Sync: $SOURCE_BRANCH → $TARGET_BRANCH" \
                  --body "Automated sync due to $TOTAL_CHANGED line changes.\n\nPlease review." \
                  --label "auto-sync"
              else
                echo "ℹ️ PR already exists: $SOURCE_BRANCH → $TARGET_BRANCH"
              fi
            else
              echo "❌ No sync needed for $TARGET_BRANCH — changes below threshold."
            fi
          done
