name: Automated Branch Sync

on:
  schedule:
    - cron: '0 10 * * *'  # Runs daily at 10:00 UTC
  workflow_dispatch:

jobs:
  sync-branches:
    runs-on: ubuntu-latest

    env:
      SOURCE_BRANCH: develop
      DEST_BRANCHES: main,qa,staging
      LINE_THRESHOLD: 100

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for diffing

      - name: Set up Git
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"

      - name: Install GitHub CLI
        uses: actions/setup-gh@v1

      - name: Authenticate with GitHub CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Check for changes and create PRs
        run: |
          IFS=',' read -ra DESTS <<< "$DEST_BRANCHES"
          for dest in "${DESTS[@]}"; do
            echo "Checking changes from $SOURCE_BRANCH → $dest"
            git fetch origin $SOURCE_BRANCH $dest

            # Get line diff
            lines_changed=$(git diff origin/$dest..origin/$SOURCE_BRANCH --shortstat | awk '{print $4 + $6}')
            lines_changed=${lines_changed:-0}
            echo "Total lines changed: $lines_changed"

            if [[ "$lines_changed" -gt "$LINE_THRESHOLD" ]]; then
              echo "Sync needed → Creating PR from $SOURCE_BRANCH to $dest"

              PR_EXISTS=$(gh pr list --base $dest --head $SOURCE_BRANCH --json number --jq 'length')
              if [[ "$PR_EXISTS" -eq "0" ]]; then
                gh pr create \
                  --base $dest \
                  --head $SOURCE_BRANCH \
                  --title "Sync: $SOURCE_BRANCH → $dest" \
                  --body "Automated sync triggered due to $lines_changed lines changed." \
                  --label "auto-sync"
              else
                echo "PR already exists from $SOURCE_BRANCH → $dest"
              fi
            else
              echo "No sync needed for $SOURCE_BRANCH → $dest"
            fi
          done
